- name: Deploy to VPS via SSH
  uses: appleboy/ssh-action@v0.1.8
  with:
    host: ${{ secrets.VPS_HOST }}
    username: ${{ secrets.VPS_USER }}
    key: ${{ secrets.VPS_SSH_KEY }}
    script: |
      cd ~/taprim

      echo "🧾 Danh sách file hiện tại:"
      ls -la

      echo "📦 Pull image mới nhất"
      docker pull ${{ env.IMAGE_NAME }}:latest

      echo "📄 Ghi file .env"
      cat <<EOF > .env
      ConnectionStrings__MyCnn=${{ secrets.MYCNN }}
      ConnectionStrings__Redis=${{ secrets.REDIS }}
      VietQr__ClientId=${{ secrets.VIETQR_CLIENTID }}
      VietQr__ApiKey=${{ secrets.VIETQR_APIKEY }}
      EOF

      echo "🔍 Kiểm tra docker-compose.yml có tồn tại không:"
      [ -f docker-compose.yml ] && echo "✅ FOUND docker-compose.yml" || (echo "❌ MISSING docker-compose.yml" && exit 1)

      echo "🚀 Chạy docker-compose up"
      docker-compose down -v --remove-orphans
      docker-compose pull
      docker-compose up -d --force-recreate

      echo "📋 Trạng thái container:"
      docker ps
